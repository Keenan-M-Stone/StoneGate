#!/usr/bin/env bash
set -euo pipefail

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/_lib.sh"

PID_FILE="/tmp/StoneGate.pid"
LOG_FILE="/tmp/StoneGate.log"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --pid) PID_FILE="$2"; shift 2;;
    --log) LOG_FILE="$2"; shift 2;;
    -h|--help)
      cat <<'EOF'
Usage: scripts/status_sim_backend [--pid <file>] [--log <file>]

Shows whether the backend pid is running and where logs are.
EOF
      exit 0
      ;;
    *)
      echo "Unknown arg: $1" >&2
      exit 1
      ;;
  esac
done

if [[ ! -f "$PID_FILE" ]]; then
  log "Not running (no pid file): $PID_FILE"
  log "Log (if any): $LOG_FILE"
  exit 0
fi

PID="$(cat "$PID_FILE" || true)"
if [[ -z "${PID:-}" ]]; then
  log "Pid file exists but empty: $PID_FILE"
  exit 1
fi

if kill -0 "$PID" >/dev/null 2>&1; then
  log "Running: pid $PID"
  log "Log: $LOG_FILE"
  exit 0
fi

log "Not running (stale pid $PID); remove $PID_FILE to clear."
log "Log: $LOG_FILE"
exit 1
